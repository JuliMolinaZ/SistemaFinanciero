// src/context/GlobalState.js
import React, { createContext, useState, useEffect } from 'react';
import { auth } from '../firebase';
import axios from 'axios';

// Configuraci√≥n global de Axios
const API_BASE_URL = 'http://localhost:5001';
axios.defaults.baseURL = API_BASE_URL;

console.log('üåê Configuraci√≥n de Axios:');
console.log('üåê API_BASE_URL:', API_BASE_URL);
console.log('üåê axios.defaults.baseURL:', axios.defaults.baseURL);

// INTERCEPTOR GLOBAL para detectar y redirigir usuarios invitados
console.log('üîí INTERCEPTOR GLOBAL INICIADO');
console.log('üîí ===========================================');
console.log('üîí SISTEMA DE BLOQUEO ACTIVADO');
console.log('üîí ===========================================');

axios.interceptors.request.use(
  (config) => {
    console.log('üîí INTERCEPTOR: Interceptando llamada a:', config.url);
    console.log('üîí INTERCEPTOR: URL completa:', `${config.baseURL}${config.url}`);
    console.log('üîí INTERCEPTOR: M√©todo:', config.method);
    console.log('üîí INTERCEPTOR: URL actual:', window.location.pathname);
    
    // Solo bloquear si la URL actual contiene complete-profile Y la llamada es espec√≠ficamente para crear usuarios
    if (window.location.pathname.includes('/complete-profile/') && 
        config.url === '/api/usuarios' && 
        config.method === 'POST') {
      console.log('üéØ INTERCEPTOR: USUARIO INVITADO DETECTADO!');
      console.log('üéØ INTERCEPTOR: ===========================================');
      console.log('üö´ INTERCEPTOR: BLOQUEANDO LLAMADA A /api/usuarios (POST)');
      console.log('üö´ INTERCEPTOR: URL bloqueada:', config.url);
      console.log('üö´ INTERCEPTOR: M√©todo:', config.method);
      console.log('üö´ INTERCEPTOR: Redirigiendo a:', window.location.pathname);
      
      // Redirigir autom√°ticamente a la ruta de invitaci√≥n
      setTimeout(() => {
        window.location.href = window.location.pathname;
      }, 100);
      
      return Promise.reject(new Error('Usuario invitado - Redirigiendo autom√°ticamente'));
    }
    
    // Permitir todas las dem√°s llamadas
    console.log('‚úÖ INTERCEPTOR: Llamada permitida - URL:', config.url, 'M√©todo:', config.method);
    return config;
  },
  (error) => {
    console.error('‚ùå INTERCEPTOR: Error en interceptor:', error);
    return Promise.reject(error);
  }
);

export const GlobalContext = createContext();

export const GlobalProvider = ({ children }) => {
  console.log('üåê GLOBAL STATE PROVIDER INICIADO');
  console.log('üåê ===========================================');
  console.log('üåê SISTEMA DE DETECCI√ìN AUTOM√ÅTICA ACTIVADO');
  console.log('üåê ===========================================');
  
  const [clientes, setClientes] = useState([]);
  const [proyectos, setProyectos] = useState([]);
  const [users, setUsers] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [profileComplete, setProfileComplete] = useState(false);
  const [profileData, setProfileData] = useState(null);
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [authLoading, setAuthLoading] = useState(true);
  
  // ELIMINADO: Sistema viejo de permisos
  // const [permisos, setPermisos] = useState([]);

  // ELIMINADO: Carga del sistema viejo de permisos
  // useEffect(() => {
  //   const fetchPermisos = async () => {
  //     try {
  //       const response = await axios.get('/api/permisos');
  //       console.log("Permisos obtenidos en GlobalState:", response.data);
  //       
  //       if (response.data && response.data.success && Array.isArray(response.data.data)) {
  //         setPermisos(response.data.data);
  //       } else if (Array.isArray(response.data)) {
  //         setPermisos(response.data);
  //       } else {
  //         console.warn("Estructura de permisos inesperada:", response.data);
  //         setPermisos([]);
  //       }
  //     } catch (error) {
  //       console.error("Error fetching permisos in GlobalState:", error);
  //         setPermisos([]);
  //       }
  //     };
  //     fetchPermisos();
  //   }, []);

  // DETECCI√ìN AUTOM√ÅTICA de usuarios invitados - se ejecuta en cada cambio de URL
  useEffect(() => {
    const checkIfInvitedUser = () => {
      if (window.location.pathname.includes('/complete-profile/')) {
        console.log('üéØ DETECCI√ìN AUTOM√ÅTICA: Usuario invitado detectado');
        console.log('üéØ URL actual:', window.location.pathname);
        console.log('üéØ Limpiando estados de Firebase');
        
        // Limpiar todos los estados relacionados con Firebase
        setCurrentUser(null);
        setProfileData(null);
        setProfileComplete(false);
        
        // Forzar logout de Firebase si est√° autenticado
        if (auth.currentUser) {
          auth.signOut().then(() => {
            console.log('üéØ Firebase logout exitoso para usuario invitado');
          }).catch((error) => {
            console.log('üéØ Error en Firebase logout:', error);
          });
        }
      }
    };

    // Verificar inmediatamente
    checkIfInvitedUser();

    // Escuchar cambios en la URL
    const handleUrlChange = () => {
      checkIfInvitedUser();
    };

    // Agregar listener para cambios de URL
    window.addEventListener('popstate', handleUrlChange);
    window.addEventListener('pushstate', handleUrlChange);
    window.addEventListener('replacestate', handleUrlChange);

    return () => {
      window.removeEventListener('popstate', handleUrlChange);
      window.removeEventListener('pushstate', handleUrlChange);
      window.removeEventListener('replacestate', handleUrlChange);
    };
  }, []);

  // Manejo de autenticaci√≥n y perfil
  useEffect(() => {
    console.log('üîê AUTH STATE CHANGED - Iniciando listener');
    console.log('üîê authLoading actual:', authLoading);
    console.log('üîê Configuraci√≥n actual:', {
      API_BASE_URL,
      'axios.defaults.baseURL': axios.defaults.baseURL,
      'window.location': window.location.href,
      'NODE_ENV': process.env.NODE_ENV
    });
    
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      console.log('üîê Firebase Auth State Changed:', user ? user.email : 'No hay usuario');
      
      // DETECCI√ìN AUTOM√ÅTICA: Si es un usuario invitado, redirigir autom√°ticamente
      if (window.location.pathname.includes('/complete-profile/')) {
        console.log("üéØ USUARIO INVITADO DETECTADO - Redirigiendo autom√°ticamente");
        console.log("üéØ URL actual:", window.location.pathname);
        console.log("üéØ No se procesar√° autenticaci√≥n de Firebase");
        setCurrentUser(null);
        setProfileData(null);
        setProfileComplete(false);
        setAuthLoading(false);
        return;
      }
      
      console.log('üîê Usuario Firebase detectado:', user ? user.email : 'No hay usuario');
      setCurrentUser(user);
      
      if (user) {
        try {
          console.log('üîê Intentando cargar perfil para usuario:', user.email);
          console.log('üîê Firebase UID:', user.uid);
          console.log('üîê API_BASE_URL configurado:', API_BASE_URL);
          console.log('üîê URL que se va a llamar:', `${API_BASE_URL}/api/usuarios/firebase/${user.uid}`);
          
          // Agregar timeout para la llamada a la API
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos de timeout
          
          let response;
          try {
            // Intentar con Axios primero
            console.log('üîê Intentando llamada con Axios...');
            response = await axios.get(`/api/usuarios/firebase/${user.uid}`, {
              signal: controller.signal
            });
            console.log('‚úÖ Llamada con Axios exitosa');
          } catch (axiosError) {
            console.log('‚ö†Ô∏è Axios fall√≥, intentando con fetch:', axiosError.message);
            console.log('‚ö†Ô∏è Detalles del error de Axios:', {
              message: axiosError.message,
              name: axiosError.name,
              response: axiosError.response?.data,
              status: axiosError.response?.status
            });
            
            // Fallback a fetch
            console.log('üîê Intentando llamada con fetch...');
            const fetchResponse = await fetch(`${API_BASE_URL}/api/usuarios/firebase/${user.uid}`, {
              signal: controller.signal
            });
            
            if (!fetchResponse.ok) {
              throw new Error(`HTTP error! status: ${fetchResponse.status}`);
            }
            
            const fetchData = await fetchResponse.json();
            response = { data: fetchData, status: fetchResponse.status, headers: fetchResponse.headers };
            console.log('‚úÖ Llamada con fetch exitosa');
          }
          
          clearTimeout(timeoutId);
          console.log("‚úÖ Conexi√≥n exitosa al backend. Datos del usuario:", response.data);
          console.log("‚úÖ Status de la respuesta:", response.status);
          console.log("‚úÖ Headers de la respuesta:", response.headers);
          
          // Verificar la estructura de la respuesta
          let userData;
          if (response.data && response.data.success && response.data.data) {
            userData = response.data.data;
            console.log('‚úÖ Datos del usuario extra√≠dos correctamente:', userData);
          } else if (response.data) {
            userData = response.data;
            console.log('‚úÖ Datos del usuario (formato alternativo):', userData);
          } else {
            throw new Error('Estructura de respuesta inesperada');
          }
          
          setProfileData(userData);
          setProfileComplete(true);
          console.log('‚úÖ Perfil del usuario cargado exitosamente');
          
        } catch (err) {
          console.error("‚ùå Error al cargar perfil:", err);
          console.error("‚ùå Detalles del error:", {
            status: err.response?.status,
            statusText: err.response?.statusText,
            data: err.response?.data,
            message: err.message,
            isAbort: err.name === 'AbortError',
            name: err.name,
            stack: err.stack
          });
          
          // Si es un timeout, mostrar mensaje espec√≠fico
          if (err.name === 'AbortError') {
            console.error('‚è∞ Timeout en la carga del perfil');
            alert("La carga del perfil tard√≥ demasiado. Por favor, recarga la p√°gina.");
            setProfileData(null);
            setProfileComplete(false);
            setAuthLoading(false);
            return;
          }
          
          // VERIFICACI√ìN AGRESIVA: Si es un usuario invitado, NO crear autom√°ticamente
          if (window.location.pathname.includes('/complete-profile/')) {
            console.log("üö´ USUARIO INVITADO DETECTADO - BLOQUEANDO CREACI√ìN AUTOM√ÅTICA");
            console.log("üö´ URL actual:", window.location.pathname);
            console.log("üö´ No se crear√° perfil autom√°ticamente");
            setProfileData(null);
            setProfileComplete(false);
            setCurrentUser(null); // Forzar logout del usuario Firebase
            setAuthLoading(false);
            return;
          }
          
          if (err.response && err.response.status === 404) {
            console.log('üîê Usuario no encontrado, intentando crear perfil...');
            try {
              const createResponse = await axios.post('/api/usuarios', {
                firebase_uid: user.uid,
                email: user.email,
                name: user.displayName || "Nombre Desconocido",
                role: "defaultRole",
                avatar: user.photoURL || ""
              });
              console.log("‚úÖ Usuario creado en el backend:", createResponse.data);
              
              // Verificar la estructura de la respuesta
              let userData;
              if (createResponse.data && createResponse.data.success && createResponse.data.data) {
                userData = createResponse.data.data;
              } else if (createResponse.data) {
                userData = createResponse.data;
              } else {
                throw new Error('Estructura de respuesta inesperada');
              }
              
              setProfileData(userData);
              setProfileComplete(true);
              console.log('‚úÖ Perfil del usuario creado exitosamente');
            } catch (createError) {
              console.error("‚ùå Error al crear el usuario:", createError);
              console.error("‚ùå Detalles del error de creaci√≥n:", {
                status: createError.response?.status,
                statusText: createError.response?.statusText,
                data: createError.response?.data,
                message: createError.message
              });
              alert("No se pudo crear tu perfil. Intenta nuevamente m√°s tarde.");
              setProfileData(null);
              setProfileComplete(false);
            }
          } else {
            console.error("‚ùå Error no manejado al cargar perfil:", err);
            console.error("‚ùå Intentando hacer debug adicional...");
            
            // Debug adicional: probar con fetch directamente
            try {
              console.log('üîç DEBUG: Probando con fetch directamente...');
              const debugResponse = await fetch(`${API_BASE_URL}/api/usuarios/firebase/${user.uid}`);
              console.log('üîç DEBUG: Response status:', debugResponse.status);
              console.log('üîç DEBUG: Response headers:', debugResponse.headers);
              
              if (debugResponse.ok) {
                const debugData = await debugResponse.json();
                console.log('üîç DEBUG: Data obtenida con fetch:', debugData);
              } else {
                console.log('üîç DEBUG: Response no OK:', debugResponse.statusText);
              }
            } catch (debugError) {
              console.error('üîç DEBUG: Error con fetch:', debugError);
            }
            
            setProfileData(null);
            setProfileComplete(false);
            alert("No se pudo cargar tu perfil. Intenta nuevamente m√°s tarde.");
          }
        }
      } else {
        console.log('üîê No hay usuario autenticado, limpiando estados');
        setProfileData(null);
        setProfileComplete(false);
        localStorage.removeItem('profileData');
        localStorage.removeItem('profileComplete');
      }
      setAuthLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Cargar datos desde localStorage
  useEffect(() => {
    const storedProfile = localStorage.getItem('profileData');
    const storedProfileComplete = localStorage.getItem('profileComplete');
    if (storedProfile) setProfileData(JSON.parse(storedProfile));
    if (storedProfileComplete) setProfileComplete(JSON.parse(storedProfileComplete));
  }, []);

  // Guardar cambios en localStorage
  useEffect(() => {
    if (profileData) {
      localStorage.setItem('profileData', JSON.stringify(profileData));
    }
    localStorage.setItem('profileComplete', JSON.stringify(profileComplete));
  }, [profileData, profileComplete]);

  return (
    <GlobalContext.Provider
      value={{
        clientes,
        setClientes,
        proyectos,
        setProyectos,
        users,
        setUsers,
        currentUser,
        setCurrentUser,
        profileComplete,
        setProfileComplete,
        profileData,
        setProfileData,
        sidebarCollapsed,
        setSidebarCollapsed,
        authLoading,
        // ELIMINADO: permisos
        // permisos,
        // setPermisos,
      }}
    >
      {children}
    </GlobalContext.Provider>
  );
};
